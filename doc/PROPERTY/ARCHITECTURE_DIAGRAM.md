# Arquitectura del Property Module Upgrade

## ğŸ“ Diagrama de Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Mapa    â”‚  â”‚ BÃºsqueda â”‚  â”‚  Upload  â”‚  â”‚  Editor  â”‚        â”‚
â”‚  â”‚Interactivoâ”‚  â”‚  PÃºblica â”‚  â”‚ ImÃ¡genes â”‚  â”‚  Lotes   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚             â”‚
        â”‚ GET /map    â”‚ GET /public â”‚ POST files  â”‚ PATCH lotes
        â”‚             â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API GATEWAY (NestJS)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              CONTROLLERS LAYER                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚ Properties   â”‚ â”‚PropertyFiles â”‚ â”‚   Public     â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ Controller   â”‚ â”‚ Controller   â”‚ â”‚ Properties   â”‚      â”‚ â”‚
â”‚  â”‚  â”‚              â”‚ â”‚              â”‚ â”‚ Controller   â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ (Auth âœ“)     â”‚ â”‚ (Auth âœ“)     â”‚ â”‚ (Public)     â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                â”‚                â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  SERVICES LAYER                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ Properties   â”‚ â”‚PropertyFiles â”‚ â”‚   Public     â”‚     â”‚ â”‚
â”‚  â”‚  â”‚   Service    â”‚ â”‚   Service    â”‚ â”‚ Properties   â”‚     â”‚ â”‚
â”‚  â”‚  â”‚              â”‚ â”‚              â”‚ â”‚   Service    â”‚     â”‚ â”‚
â”‚  â”‚  â”‚ - CRUD       â”‚ â”‚ - Upload     â”‚ â”‚ - Search     â”‚     â”‚ â”‚
â”‚  â”‚  â”‚ - Validation â”‚ â”‚ - Delete     â”‚ â”‚ - Filter     â”‚     â”‚ â”‚
â”‚  â”‚  â”‚ - Business   â”‚ â”‚ - Reorder    â”‚ â”‚ - Sanitize   â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                â”‚                â”‚                 â”‚
â”‚            â”‚         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”          â”‚                 â”‚
â”‚            â”‚         â”‚  Storage   â”‚          â”‚                 â”‚
â”‚            â”‚         â”‚  Service   â”‚          â”‚                 â”‚
â”‚            â”‚         â”‚            â”‚          â”‚                 â”‚
â”‚            â”‚         â”‚ - Process  â”‚          â”‚                 â”‚
â”‚            â”‚         â”‚ - Sharp    â”‚          â”‚                 â”‚
â”‚            â”‚         â”‚ - Versions â”‚          â”‚                 â”‚
â”‚            â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚                 â”‚
â”‚            â”‚                â”‚                â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  DATA ACCESS LAYER                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚           Property Entity (Mongoose)               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - valor_venta_detallado                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - valor_alquiler_detallado                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - publicar_para_venta                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - publicar_para_alquiler                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - imagenes[]                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - planos[]                                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - imagen_satelital                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - lotes[]                                       â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     MongoDB        â”‚
                    â”‚                    â”‚
                    â”‚ - properties       â”‚
                    â”‚ - Ãndices:         â”‚
                    â”‚   * lat/lng        â”‚
                    â”‚   * status         â”‚
                    â”‚   * publicar_*     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FILE SYSTEM / STORAGE                         â”‚
â”‚                                                                  â”‚
â”‚  uploads/properties/{propertyId}/                               â”‚
â”‚  â”œâ”€â”€ images/                                                    â”‚
â”‚  â”‚   â”œâ”€â”€ original/                                              â”‚
â”‚  â”‚   â”œâ”€â”€ slider/  (800x600)                                     â”‚
â”‚  â”‚   â””â”€â”€ thumb/   (200x200)                                     â”‚
â”‚  â”œâ”€â”€ planos/                                                    â”‚
â”‚  â”‚   â””â”€â”€ original/                                              â”‚
â”‚  â”œâ”€â”€ satellite/                                                 â”‚
â”‚  â”‚   â””â”€â”€ original/                                              â”‚
â”‚  â””â”€â”€ documentos/                                                â”‚
â”‚                                                                  â”‚
â”‚  Future: AWS S3 / Google Cloud Storage / Azure Blob            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo de Datos: Subida de Imagen

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Frontend â”‚ 1. POST /properties/:id/imagenes
â”‚         â”‚    FormData with files
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PropertyFilesControllerâ”‚ 2. Receive files
â”‚  @UseInterceptors   â”‚    Validate auth
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PropertyFilesService â”‚ 3. Business logic
â”‚                     â”‚    - Check property exists
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - Validate files
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StorageService     â”‚ 4. Process & Save
â”‚                     â”‚    - Sharp processing
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - Create versions
     â”‚                     - Save to disk
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     â”‚
     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚File     â”‚         â”‚MongoDB   â”‚ 5. Update DB
â”‚System   â”‚         â”‚Property  â”‚    - Add to imagenes[]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - Set metadata
     â”‚                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚Return Property  â”‚ 6. Response
     â”‚  with updated   â”‚    - Updated property
     â”‚  imagenes[]     â”‚    - All versions URLs
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ºï¸ Flujo de Datos: BÃºsqueda en Mapa

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Frontend â”‚ 1. GET /properties/map
â”‚  Map    â”‚    ?minLat=X&maxLat=Y&minLng=A&maxLng=B
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PublicController     â”‚ 2. No auth required
â”‚  (Public endpoint)  â”‚    Validate bounds
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PublicProperties     â”‚ 3. Build query
â”‚Service              â”‚    - Filter by bounds
â”‚                     â”‚    - Filter by public flags
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - Limit to 500
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MongoDB              â”‚ 4. Query with indexes
â”‚  properties         â”‚    - direccion.latitud
â”‚  (indexed)          â”‚    - direccion.longitud
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - publicar_para_venta
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Sanitize & Format    â”‚ 5. Process results
â”‚                     â”‚    - Select minimal fields
â”‚                     â”‚    - Format for markers
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Return Array         â”‚ 6. Response
â”‚ [{id, lat, lng,     â”‚    Lightweight JSON
â”‚   precio, img}]     â”‚    < 50KB typical
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Flujo de Datos: Sistema de Lotes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Frontend â”‚ 1. Upload satellite image
â”‚         â”‚    POST /properties/:id/imagen-satelital
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PropertyFilesService â”‚ 2. Process image
â”‚                     â”‚    - Sharp extracts dimensions
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - Save to disk
     â”‚                     - Update DB
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MongoDB  â”‚ imagen_satelital: {
â”‚         â”‚   ancho: 1920,
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   alto: 1080,
              pixels_por_metro: 0  // Not calibrated yet
              }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Frontend â”‚ 3. User calibrates
â”‚         â”‚    POST /properties/:id/imagen-satelital/calibrar
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    { pixels_por_metro: 10.5 }
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MongoDB  â”‚ Update: pixels_por_metro = 10.5
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Frontend â”‚ 4. User draws lots
â”‚ Canvas  â”‚    - Click to create polygon
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    - Calculate area using calibration
     â”‚         - Set price, status
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Frontend â”‚ 5. Save lots
â”‚         â”‚    PATCH /properties/:id
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    { lotes: [...] }
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PropertiesService    â”‚ 6. Validate & save
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MongoDB  â”‚ lotes: [
â”‚         â”‚   {
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     id: 'lote-1',
                coordenadas: [...],
                superficie_m2: 250,
                precio: 50000
              }
            ]
```

---

## ğŸ“¦ Capas y Responsabilidades

### 1. Controllers Layer

**Responsabilidad**: Manejo de HTTP requests/responses

- ValidaciÃ³n de entrada (DTOs)
- AutenticaciÃ³n y autorizaciÃ³n
- Manejo de archivos multipart
- Formateo de respuestas

### 2. Services Layer

**Responsabilidad**: LÃ³gica de negocio

- ValidaciÃ³n de reglas de negocio
- CoordinaciÃ³n entre servicios
- TransformaciÃ³n de datos
- GestiÃ³n de transacciones

### 3. Storage Service

**Responsabilidad**: GestiÃ³n de archivos

- Procesamiento de imÃ¡genes (Sharp)
- CreaciÃ³n de versiones
- Almacenamiento fÃ­sico
- EliminaciÃ³n de archivos
- **AbstracciÃ³n**: Preparado para migrar a cloud

### 4. Data Access Layer

**Responsabilidad**: Persistencia

- Esquemas de Mongoose
- ValidaciÃ³n de datos
- Relaciones entre entidades
- Ãndices y optimizaciÃ³n

---

## ğŸ” Seguridad en Capas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Guards (Auth)                    â”‚
â”‚     - JWT validation                 â”‚
â”‚     - Role-based access              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Validators (DTOs)                â”‚
â”‚     - Type checking                  â”‚
â”‚     - Range validation               â”‚
â”‚     - Format validation              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Business Logic (Services)        â”‚
â”‚     - Entity validation              â”‚
â”‚     - Business rules                 â”‚
â”‚     - Data integrity                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Data Sanitization                â”‚
â”‚     - Remove sensitive fields        â”‚
â”‚     - Privacy controls               â”‚
â”‚     - Public/Private separation      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Escalabilidad

### Horizontal Scaling

- MÃºltiples instancias de NestJS
- Load balancer (Nginx/AWS ALB)
- Session-less (JWT)
- Shared storage (S3)

### Vertical Scaling

- Procesamiento de imÃ¡genes en background
- Queue system (Bull/Redis)
- CDN para archivos estÃ¡ticos
- Database read replicas

### Caching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend  â”‚ Cache: 5 min
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   CDN      â”‚ Cache: 1 hour (images)
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Redis    â”‚ Cache: 15 min (queries)
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDB   â”‚ Source of truth
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Flujo de MigraciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Old Schema                                  â”‚
â”‚  - valor_venta: Number                       â”‚
â”‚  - valor_alquiler: Number                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Migration Script
               â”‚ (scripts/migrate-properties.js)
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  New Schema (Compatible)                     â”‚
â”‚  - valor_venta: Number (kept)                â”‚
â”‚  - valor_venta_detallado: Object (new)       â”‚
â”‚  - valor_alquiler: Number (kept)             â”‚
â”‚  - valor_alquiler_detallado: Object (new)    â”‚
â”‚  - publicar_para_venta: Boolean (new)        â”‚
â”‚  - publicar_para_alquiler: Boolean (new)     â”‚
â”‚  - imagenes: Array (new)                     â”‚
â”‚  - planos: Array (new)                       â”‚
â”‚  - lotes: Array (new)                        â”‚
â”‚  - imagen_satelital: Object (new)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

Este diagrama muestra la arquitectura completa del sistema actualizado, incluyendo todas las capas, flujos de datos, y consideraciones de escalabilidad.
